// 对话服务
import { getSupabase } from './supabase'
import { getSupabaseServiceRoleClient } from './supabase-server'
import { generateCompanionResponse, moderateContent } from './deepseek-chat'
import { getCompanion, updateIntimacyLevel } from './companion-service'
import type { ChatMessage } from './database-setup'

export interface SendMessageRequest {
  companionId: string
  content: string
  messageType?: 'text' | 'voice' | 'image'
}

export interface SendMessageResponse {
  message: ChatMessage
  companionResponse: ChatMessage
  intimacyLevel: number
  quotaRemaining?: number
}

// 发送消息 (客户端调用API)
export async function sendMessage(
  userId: string,
  request: SendMessageRequest
): Promise<SendMessageResponse> {
  const supabase = getSupabase()
  const { data: { session } } = await supabase.auth.getSession()
  
  if (!session) {
    throw new Error('用户未登录')
  }
  
  const response = await fetch(`/api/chat/${request.companionId}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${session.access_token}`
    },
    body: JSON.stringify({
      content: request.content,
      messageType: request.messageType
    })
  })
  
  if (!response.ok) {
    const error = await response.json()
    throw new Error(error.error || '发送消息失败')
  }
  
  return await response.json()
}

// 获取对话历史 (客户端调用API)
export async function getChatHistory(
  userId: string,
  companionId: string,
  limit: number = 50
): Promise<ChatMessage[]> {
  const supabase = getSupabase()
  const { data: { session } } = await supabase.auth.getSession()
  
  if (!session) {
    throw new Error('用户未登录')
  }
  
  const response = await fetch(`/api/chat/${companionId}?limit=${limit}`, {
    headers: {
      'Authorization': `Bearer ${session.access_token}`
    }
  })
  
  if (!response.ok) {
    const error = await response.json()
    throw new Error(error.error || '获取对话历史失败')
  }
  
  const { messages } = await response.json()
  return messages
}

// 服务端发送消息 (用于API路由)
export async function sendMessageServer(
  userId: string,
  request: SendMessageRequest
): Promise<SendMessageResponse> {
  const supabase = getSupabase()
  
  // 1. 检查消息配额
  const canSend = await checkMessageQuota(userId)
  if (!canSend) {
    throw new Error('今日消息数量已达上限，请升级到Premium获得无限对话')
  }
  
  // 2. 内容安全检查
  if (!moderateContent(request.content)) {
    throw new Error('消息内容不符合社区规范，请修改后重试')
  }
  
  // 3. 获取伴侣信息
  const companion = await getCompanion(request.companionId, userId)
  if (!companion) {
    throw new Error('伴侣不存在或无权限访问')
  }
  
  // 4. 获取对话历史
  const chatHistory = await getChatHistoryServer(userId, request.companionId, 10)
  
  // 5. 保存用户消息
  const { data: userMessage, error: userError } = await supabase
    .from('chat_messages')
    .insert({
      user_id: userId,
      companion_id: request.companionId,
      sender_type: 'user',
      content: request.content,
      message_type: request.messageType || 'text'
    })
    .select()
    .single()
  
  if (userError) throw userError
  
  // 6. 生成AI回复
  const aiResponse = await generateCompanionResponse(
    companion,
    request.content,
    chatHistory
  )
  
  // 7. 保存AI回复
  const { data: companionMessage, error: companionError } = await supabase
    .from('chat_messages')
    .insert({
      user_id: userId,
      companion_id: request.companionId,
      sender_type: 'companion',
      content: aiResponse,
      message_type: 'text'
    })
    .select()
    .single()
  
  if (companionError) throw companionError
  
  // 8. 更新消息配额
  await updateMessageQuota(userId)
  
  // 9. 更新亲密度
  const newIntimacyLevel = await updateIntimacyLevel(userId, request.companionId, 1)
  
  // 10. 获取剩余配额
  const quotaRemaining = await getRemainingQuota(userId)
  
  return {
    message: userMessage,
    companionResponse: companionMessage,
    intimacyLevel: newIntimacyLevel,
    quotaRemaining
  }
}

// 服务端获取对话历史
export async function getChatHistoryServer(
  userId: string,
  companionId: string,
  limit: number = 50
): Promise<ChatMessage[]> {
  const supabase = getSupabase()
  
  const { data, error } = await supabase
    .from('chat_messages')
    .select('*')
    .eq('user_id', userId)
    .eq('companion_id', companionId)
    .order('created_at', { ascending: false })
    .limit(limit)
  
  if (error) throw error
  
  // 返回正序排列
  return (data || []).reverse()
}

// 删除对话记录
export async function deleteChatHistory(
  userId: string,
  companionId: string
): Promise<void> {
  const supabase = getSupabase()
  
  const { error } = await supabase
    .from('chat_messages')
    .delete()
    .eq('user_id', userId)
    .eq('companion_id', companionId)
  
  if (error) throw error
}

// 检查消息配额
async function checkMessageQuota(userId: string): Promise<boolean> {
  const supabase = getSupabaseServiceRoleClient()
  
  const { data, error } = await supabase.rpc('check_message_quota', {
    p_user_id: userId
  })
  
  if (error) {
    console.error('配额检查失败:', error)
    return false
  }
  
  return data
}

// 更新消息配额
async function updateMessageQuota(userId: string): Promise<void> {
  const supabase = getSupabase()
  const today = new Date().toISOString().split('T')[0]
  
  // 使用upsert更新或插入今日配额
  const { error } = await supabase
    .from('daily_message_quotas')
    .upsert({
      user_id: userId,
      date: today,
      message_count: 1
    }, {
      onConflict: 'user_id,date',
      ignoreDuplicates: false
    })
  
  if (error) {
    // 如果upsert失败，尝试更新
    const { error: updateError } = await supabase
      .from('daily_message_quotas')
      .update({
        message_count: supabase.rpc('message_count + 1')
      })
      .eq('user_id', userId)
      .eq('date', today)
    
    if (updateError) {
      console.error('配额更新失败:', updateError)
    }
  }
}

// 获取剩余配额
async function getRemainingQuota(userId: string): Promise<number | undefined> {
  const supabase = getSupabase()
  const today = new Date().toISOString().split('T')[0]
  
  // 获取用户订阅信息
  const { data: subscription } = await supabase
    .from('subscriptions')
    .select('type, daily_message_limit')
    .eq('user_id', userId)
    .single()
  
  if (!subscription) return undefined
  
  // 付费用户无限制
  if (subscription.type === 'premium') {
    return undefined
  }
  
  // 获取今日使用量
  const { data: quota } = await supabase
    .from('daily_message_quotas')
    .select('message_count')
    .eq('user_id', userId)
    .eq('date', today)
    .single()
  
  const used = quota?.message_count || 0
  return Math.max(0, subscription.daily_message_limit - used)
}

// 获取用户订阅状态
export async function getUserSubscription(userId: string) {
  const supabase = getSupabase()
  
  const { data, error } = await supabase
    .from('subscriptions')
    .select('*')
    .eq('user_id', userId)
    .order('created_at', { ascending: false })
    .limit(1)
    .single()
  
  if (error || !data) {
    // 返回默认免费订阅
    return {
      type: 'free',
      daily_message_limit: 20,
      features: []
    }
  }
  
  return data
}